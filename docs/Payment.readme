SOFTWARE REQUIREMENT SPECIFICATION
PAYMENT SYSTEM (COD & VNPAY)

Phi√™n b·∫£n: 1.1
Ng√†y: 23/01/2026
Module: F-PAYMENT
Ph·ª• thu·ªôc: F-ORDER, F-CART
Ki·∫øn tr√∫c: Spring MVC + Thymeleaf (SSR)
Ph·∫°m vi: Thanh to√°n ƒë∆°n h√†ng sau checkout (Single-shop per order)

1. T·ªîNG QUAN
1.1. M·ª•c ti√™u

Payment System ch·ªãu tr√°ch nhi·ªám:

Cho ph√©p ng∆∞·ªùi mua l·ª±a ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n

H·ªó tr·ª£ thanh to√°n COD v√† VNPay

Qu·∫£n l√Ω tr·∫°ng th√°i thanh to√°n c·ªßa ƒë∆°n h√†ng

ƒê·ªìng b·ªô tr·∫°ng th√°i Payment ‚Üî Order

ƒê·∫£m b·∫£o t√≠nh to√†n v·∫πn d·ªØ li·ªáu v√† b·∫£o m·∫≠t giao d·ªãch

1.2. Ph·∫°m vi h·ªá th·ªëng
Th√†nh ph·∫ßn	Tr·∫°ng th√°i
COD	‚úÖ Phase 1
VNPay Redirect + Callback	‚úÖ Phase 1
Refund	üîú Phase 2
Webhook n√¢ng cao	üîú Phase 2
Multi-payment / Split payment	‚ùå Kh√¥ng h·ªó tr·ª£

Gi·ªõi h·∫°n thi·∫øt k·∫ø:

M·ªói Order ch·ªâ c√≥ 1 Payment

M·ªói Order hi·ªán t·∫°i ch·ªâ thu·ªôc 1 Shop

1.3. ƒê·ªëi t∆∞·ª£ng s·ª≠ d·ª•ng
Vai tr√≤	M√¥ t·∫£
Buyer	Ch·ªçn v√† th·ª±c hi·ªán thanh to√°n
System	X·ª≠ l√Ω redirect, callback, c·∫≠p nh·∫≠t tr·∫°ng th√°i
Admin	Theo d√µi tr·∫°ng th√°i thanh to√°n
2. LU·ªíNG NGHI·ªÜP V·ª§ T·ªîNG QU√ÅT
Cart
  ‚Üì
Checkout
  ‚Üì
Create Order (PENDING / PENDING_PAYMENT)
  ‚Üì
Select Payment Method
  ‚Üì
+-------------------+--------------------+
|       COD         |        VNPay       |
+-------------------+--------------------+
| Payment = PENDING | Payment = INIT     |
| Order = CONFIRMED | Redirect VNPay     |
|                   | VNPay Callback     |
|                   | Verify checksum    |
|                   | Update Order       |
+-------------------+--------------------+

3. Y√äU C·∫¶U CH·ª®C NƒÇNG
3.1. Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n

FUNC-PAY-001

M√¥ t·∫£:
Ng∆∞·ªùi d√πng ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n cho ƒë∆°n h√†ng sau khi checkout.

Ph∆∞∆°ng th·ª©c h·ªó tr·ª£:

COD

VNPAY

Input:

Tr∆∞·ªùng	Ki·ªÉu	B·∫Øt bu·ªôc
paymentMethod	ENUM (COD, VNPAY)	‚úÖ

ƒêi·ªÅu ki·ªán:

Ch·ªâ buyer s·ªü h·ªØu order m·ªõi ƒë∆∞·ª£c ch·ªçn payment

Order ch∆∞a c√≥ payment SUCCESS

3.2. T·∫°o Payment khi t·∫°o Order

FUNC-PAY-002

M√¥ t·∫£:
Khi ƒë∆°n h√†ng ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng, h·ªá th·ªëng kh·ªüi t·∫°o b·∫£n ghi Payment t∆∞∆°ng ·ª©ng.

X·ª≠ l√Ω:

Payment Method	Payment Status	Order Status
COD	PENDING	CONFIRMED
VNPAY	INIT	PENDING_PAYMENT

R√†ng bu·ªôc:

M·ªói Order ch·ªâ c√≥ 1 Payment

payments.order_id l√† unique

3.3. Thanh to√°n COD

FUNC-PAY-003

Lu·ªìng x·ª≠ l√Ω:

User ch·ªçn COD

Order ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng

Payment ƒë∆∞·ª£c t·∫°o v·ªõi:

method = COD

status = PENDING

Order ƒë∆∞·ª£c x√°c nh·∫≠n:

status = CONFIRMED

Redirect sang trang chi ti·∫øt ƒë∆°n h√†ng

ƒê·∫∑c ƒëi·ªÉm:

Kh√¥ng g·ªçi gateway ngo√†i

Thanh to√°n th·ª±c t·∫ø x·∫£y ra khi giao h√†ng

3.4. Thanh to√°n VNPay

FUNC-PAY-004

Lu·ªìng chi ti·∫øt:

User ch·ªçn VNPay

System t·∫°o Payment record:

status = INIT

System build VNPay URL

Redirect user sang VNPay

User th·ª±c hi·ªán thanh to√°n

VNPay redirect v·ªÅ callback URL

3.5. X·ª≠ l√Ω VNPay Callback

FUNC-PAY-005

Callback URL:

GET /payments/vnpay/callback


X·ª≠ l√Ω:

Tr∆∞·ªùng h·ª£p	Payment Status	Order Status
Th√†nh c√¥ng	SUCCESS	CONFIRMED
Th·∫•t b·∫°i	FAILED	CANCELLED
Sai checksum	FAILED	PENDING_PAYMENT

Y√™u c·∫ßu:

Verify checksum VNPay

L∆∞u raw callback data ƒë·ªÉ audit/debug

4. TR·∫†NG TH√ÅI
4.1. PaymentStatus
INIT        - Kh·ªüi t·∫°o, ch∆∞a redirect
PENDING     - COD ch·ªù thanh to√°n
SUCCESS     - Thanh to√°n th√†nh c√¥ng
FAILED      - Thanh to√°n th·∫•t b·∫°i
CANCELLED   - H·ªßy thanh to√°n

4.2. OrderStatus (li√™n quan Payment)
PENDING_PAYMENT - Ch·ªù thanh to√°n online
CONFIRMED       - ƒê∆°n ƒë√£ x√°c nh·∫≠n
CANCELLED       - ƒê∆°n b·ªã h·ªßy

5. THI·∫æT K·∫æ DATABASE
5.1. B·∫£ng payments
C·ªôt	Ki·ªÉu	M√¥ t·∫£
id	UUID	Primary Key
order_id	UUID	FK ‚Üí orders (unique)
method	ENUM	COD / VNPAY
amount	DECIMAL	T·ªïng ti·ªÅn
status	ENUM	INIT / PENDING / SUCCESS / FAILED / CANCELLED
transaction_id	VARCHAR	vnp_TxnRef
gateway_transaction_id	VARCHAR	vnp_TransactionNo
gateway_response	TEXT	Raw callback
created_at	TIMESTAMP	Ng√†y t·∫°o
updated_at	TIMESTAMP	Ng√†y c·∫≠p nh·∫≠t
6. ROUTES (MVC)
Method	URL	M√¥ t·∫£
POST	/orders/create	T·∫°o order + payment
GET	/payments/{orderId}	Trang ch·ªçn payment
POST	/payments/cod/confirm	X√°c nh·∫≠n COD
GET	/payments/vnpay/redirect	Redirect VNPay
GET	/payments/vnpay/callback	VNPay callback
7. FRONTEND (THYMELEAF)
7.1. Trang ch·ªçn thanh to√°n

Template:

templates/payments/select.html


Th√†nh ph·∫ßn:

Radio button: COD / VNPay

Hi·ªÉn th·ªã t·ªïng ti·ªÅn

Button ‚ÄúThanh to√°n‚Äù

8. SECURITY & VALIDATION

Ch·ªâ user s·ªü h·ªØu order ƒë∆∞·ª£c thanh to√°n

Kh√¥ng cho thanh to√°n l·∫°i order ƒë√£ SUCCESS

Verify checksum VNPay

CSRF protection

Validate order status tr∆∞·ªõc m·ªói b∆∞·ªõc

9. X·ª¨ L√ù L·ªñI
Tr∆∞·ªùng h·ª£p	X·ª≠ l√Ω
VNPay timeout	Payment FAILED
Callback sai checksum	Reject & log
User back khi ƒëang pay	Order gi·ªØ PENDING_PAYMENT
Order ƒë√£ CONFIRMED	Kh√¥ng cho pay l·∫°i
10. PHASE M·ªû R·ªòNG
Phase	N·ªôi dung
Phase 2	Refund
Phase 2	Webhook async
Phase 3	Multi-shop payment