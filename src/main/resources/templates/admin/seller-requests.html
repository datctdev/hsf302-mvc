<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Yêu Cầu Seller - E-commerce</title>
    
    <!-- CSS -->
    <link rel="stylesheet" th:href="@{/css/base.css}">
    <link rel="stylesheet" th:href="@{/css/layout.css}">
    <link rel="stylesheet" th:href="@{/css/components.css}">
    <link rel="stylesheet" th:href="@{/css/admin.css}">
</head>
<body>
    <!-- Admin Header -->
    <th:block th:replace="~{fragments/header :: header-admin}"></th:block>
    
    <!-- Admin Navigation -->
    <th:block th:replace="~{fragments/nav-admin :: nav-admin}"></th:block>
    
    <!-- Main Content -->
    <main class="main-content admin-content">
        <div class="container">
            <div class="filters">
                <label for="statusFilter">Lọc theo trạng thái: </label>
                <select id="statusFilter" onchange="filterRequests()">
                    <option value="">Tất cả</option>
                    <option value="PENDING" th:selected="${status == 'PENDING'}">Đang chờ</option>
                    <option value="APPROVED" th:selected="${status == 'APPROVED'}">Đã duyệt</option>
                    <option value="REJECTED" th:selected="${status == 'REJECTED'}">Đã từ chối</option>
                </select>
            </div>

            <!-- Flash Messages -->
            <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
            <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

            <div id="requestsContainer" class="requests-list">
                <!-- Requests loaded from Model -->
                <div th:if="${requests != null and !requests.empty}" th:each="request : ${requests}">
                    <div class="request-card">
                        <div class="request-header">
                            <h3 th:text="${request.shopName}">Shop Name</h3>
                            <span class="status-badge" 
                                  th:classappend="'status-' + ${request.status.toLowerCase()}"
                                  th:text="${request.status == 'PENDING'} ? 'Đang chờ' : (${request.status == 'APPROVED'} ? 'Đã duyệt' : 'Đã từ chối')">Status</span>
                        </div>
                        <div class="request-details">
                            <div class="detail-item">
                                <label>User ID:</label>
                                <span th:text="${request.userId}">User ID</span>
                            </div>
                            <div class="detail-item">
                                <label>Số điện thoại:</label>
                                <span th:text="${request.shopPhone ?: 'N/A'}">Phone</span>
                            </div>
                            <div class="detail-item">
                                <label>Địa chỉ:</label>
                                <span th:text="${request.shopAddress ?: 'N/A'}">Address</span>
                            </div>
                            <div class="detail-item">
                                <label>Ngày tạo:</label>
                                <span th:text="${#temporals.format(request.createdAt, 'dd/MM/yyyy HH:mm')}">Date</span>
                            </div>
                            <div th:if="${request.reviewedAt != null}" class="detail-item">
                                <label>Ngày duyệt:</label>
                                <span th:text="${#temporals.format(request.reviewedAt, 'dd/MM/yyyy HH:mm')}">Date</span>
                            </div>
                            <div th:if="${request.rejectionReason != null}" class="detail-item">
                                <label>Lý do từ chối:</label>
                                <span th:text="${request.rejectionReason}" style="color: red;">Reason</span>
                            </div>
                            <div th:if="${request.shopDescription != null}" class="detail-item">
                                <label>Mô tả shop:</label>
                                <span th:text="${request.shopDescription}">Description</span>
                            </div>
                        </div>
                        <div th:if="${request.logoUrl != null or request.coverImageUrl != null}" class="request-images" style="margin-top: 1rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                            <div th:if="${request.logoUrl != null}">
                                <label>Logo:</label>
                                <img th:src="${request.logoUrl}" alt="Logo" style="max-width: 150px; max-height: 150px; border-radius: 4px; object-fit: cover; display: block; margin-top: 0.5rem;">
                            </div>
                            <div th:if="${request.coverImageUrl != null}">
                                <label>Ảnh bìa:</label>
                                <img th:src="${request.coverImageUrl}" alt="Cover" style="max-width: 300px; max-height: 150px; border-radius: 4px; object-fit: cover; display: block; margin-top: 0.5rem;">
                            </div>
                        </div>
                        <div class="request-actions" th:if="${request.status == 'PENDING'}">
                            <form th:action="@{'/admin/seller-requests/' + ${request.id} + '/approve'}" method="post" style="display: inline;">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                <button type="submit" class="btn btn-success" onclick="return confirm('Bạn có chắc muốn duyệt yêu cầu này?')">Duyệt</button>
                            </form>
                            <button class="btn btn-danger" th:attr="data-request-id=${request.id}" onclick="openRejectModal(this.getAttribute('data-request-id'))">Từ chối</button>
                        </div>
                    </div>
                </div>
                <div th:if="${requests == null or requests.empty}" class="empty-state">
                    <h3>Không có yêu cầu nào</h3>
                    <p>Hiện tại không có yêu cầu nào phù hợp với bộ lọc của bạn.</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Reject Modal -->
    <div id="rejectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Từ chối Yêu cầu</h3>
            </div>
            <form id="rejectForm" method="post">
                <!-- CSRF Token -->
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                
                <div class="form-group">
                    <label for="rejectionReason">Lý do từ chối *</label>
                    <textarea id="rejectionReason" name="rejectionReason" required placeholder="Nhập lý do từ chối..."></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeRejectModal()">Hủy</button>
                    <button type="submit" class="btn btn-danger">Từ chối</button>
                </div>
            </form>
        </div>
    </div>

    <!-- JavaScript -->
    <script th:src="@{/js/common.js}"></script>
    <script th:src="@{/js/admin.js}"></script>
    <script>
        let currentRejectRequestId = null;

        function filterRequests() {
            const statusFilter = document.getElementById('statusFilter').value;
            if (statusFilter) {
                window.location.href = '/admin/seller-requests?status=' + statusFilter;
            } else {
                window.location.href = '/admin/seller-requests';
            }
        }

        function openRejectModal(requestId) {
            currentRejectRequestId = requestId;
            const modal = document.getElementById('rejectModal');
            const form = document.getElementById('rejectForm');
            if (modal && form) {
                // Update form action with request ID
                form.action = '/admin/seller-requests/' + requestId + '/reject';
                modal.style.display = 'block';
            }
        }

        function closeRejectModal() {
            currentRejectRequestId = null;
            const modal = document.getElementById('rejectModal');
            const form = document.getElementById('rejectForm');
            if (modal) {
                modal.style.display = 'none';
            }
            if (form) {
                form.reset();
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('rejectModal');
            if (event.target === modal) {
                closeRejectModal();
            }
        }
    </script>
</body>
</html>
