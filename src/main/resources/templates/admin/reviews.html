<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Đánh Giá - Admin</title>

    <link rel="stylesheet" th:href="@{/css/base.css}">
    <link rel="stylesheet" th:href="@{/css/layout.css}">
    <link rel="stylesheet" th:href="@{/css/components.css}">
    <link rel="stylesheet" th:href="@{/css/admin.css}">

    <style>
        /* Base styles from previous step */
        .review-table-row td { vertical-align: top; padding: 1rem; }
        .product-info-cell { display: flex; gap: 10px; max-width: 300px; }
        .product-thumb { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; border: 1px solid #eee; }
        .product-name { font-size: 0.9rem; color: #333; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; font-weight: 500;}
        .shop-name { font-size: 0.8rem; color: #888; margin-top: 2px; }
        .user-info-cell { display: flex; align-items: center; gap: 8px; }
        .user-avatar-small { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; background: #eee; }
        .rating-stars { color: #ffce3d; font-size: 0.9rem; margin-bottom: 4px; }
        .review-content { font-size: 0.95rem; color: #555; line-height: 1.4; }
        .review-images-grid { display: flex; gap: 5px; margin-top: 8px; }
        .review-img-small { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; cursor: pointer; border: 1px solid #eee; transition: transform 0.2s;}
        .review-img-small:hover { transform: scale(1.05); border-color: var(--primary-color); }

        /* --- TABS STYLE --- */
        .shopee-tabs {
            display: flex;
            background: #fff;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 1.5rem;
            border-radius: 4px 4px 0 0;
        }
        .shopee-tab-item {
            padding: 1rem 1.5rem;
            font-size: 1rem;
            color: #555;
            cursor: pointer;
            text-decoration: none;
            position: relative;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .shopee-tab-item:hover {
            color: var(--primary-color);
        }
        .shopee-tab-item.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
        }
        .badge-count {
            background: #ff4d4f;
            color: white;
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 10px;
            line-height: 1;
        }

        /* Report Styles */
        .report-reason-box {
            background: #fff1f0;
            border: 1px solid #ffa39e;
            padding: 8px 12px;
            border-radius: 4px;
            margin-bottom: 8px;
            font-size: 0.85rem;
            color: #cf1322;
        }
        .report-meta { font-size: 0.8rem; color: #888; margin-top: 4px; }

        /* Filter Bar Grid */
        .admin-filter-bar {
            background: #fff; padding: 1.25rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 1.5rem;
            display: grid; grid-template-columns: 1.5fr 1.5fr 1fr 1fr auto; gap: 15px; align-items: end;
        }
        .filter-item { width: 100%; }
        .filter-item label { font-size: 0.85rem; font-weight: 600; color: #555; margin-bottom: 0.5rem; display: block; white-space: nowrap; }
        .filter-item .form-control { width: 100%; height: 40px; padding: 0.375rem 0.75rem; border: 1px solid #dee2e6; border-radius: 4px; }
        .filter-actions { display: flex; gap: 10px; }
        .filter-actions .btn { height: 40px; display: flex; align-items: center; justify-content: center; padding: 0 1.5rem; white-space: nowrap; }
    </style>
</head>
<body>
<th:block th:replace="~{fragments/header :: header-admin}"></th:block>
<th:block th:replace="~{fragments/nav-admin :: nav-admin}"></th:block>

<main class="main-content admin-content">
    <div class="container">
        <div class="page-title">
            <h1>Quản Lý Đánh Giá</h1>
        </div>

        <div class="shopee-tabs">
            <a th:href="@{/admin/reviews(tab='list')}"
               class="shopee-tab-item"
               th:classappend="${currentTab == 'list'} ? 'active'">
                Tất cả đánh giá
            </a>
            <a th:href="@{/admin/reviews(tab='reports')}"
               class="shopee-tab-item"
               th:classappend="${currentTab == 'reports'} ? 'active'">
                Báo cáo vi phạm
                <span class="badge-count" th:if="${pendingReportCount > 0}" th:text="${pendingReportCount}">0</span>
            </a>
        </div>

        <div th:if="${currentTab == 'list'}">
            <form method="get" th:action="@{/admin/reviews}" class="admin-filter-bar">
                <input type="hidden" name="tab" value="list">

                <div class="filter-item">
                    <label>Gian hàng (Shop)</label>
                    <select name="shopId" class="form-control">
                        <option value="">Tất cả Shop</option>
                        <option th:each="shop : ${shops}" th:value="${shop.id}" th:text="${shop.name}" th:selected="${currentShopId != null and currentShopId.equals(shop.id)}"></option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>Tìm kiếm</label>
                    <input type="text" name="keyword" th:value="${keyword}" placeholder="Email user, tên sản phẩm..." class="form-control">
                </div>
                <div class="filter-item">
                    <label>Số sao</label>
                    <select name="rating" class="form-control">
                        <option value="">Tất cả</option>
                        <option value="5" th:selected="${currentRating == 5}">⭐⭐⭐⭐⭐</option>
                        <option value="4" th:selected="${currentRating == 4}">⭐⭐⭐⭐</option>
                        <option value="3" th:selected="${currentRating == 3}">⭐⭐⭐</option>
                        <option value="2" th:selected="${currentRating == 2}">⭐⭐</option>
                        <option value="1" th:selected="${currentRating == 1}">⭐</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>Trạng thái</label>
                    <select name="status" class="form-control">
                        <option value="">Tất cả</option>
                        <option th:each="st : ${statuses}" th:value="${st}" th:text="${st}" th:selected="${currentStatus == st}"></option>
                    </select>
                </div>
                <div class="filter-actions">
                    <button type="submit" class="btn btn-primary">Lọc</button>
                    <a th:href="@{/admin/reviews(tab='list')}" class="btn btn-outline-secondary">Reset</a>
                </div>
            </form>

            <div class="card" style="padding: 0;">
                <table class="table">
                    <thead>
                    <tr>
                        <th style="width: 250px;">Sản phẩm</th>
                        <th style="width: 200px;">Người đánh giá</th>
                        <th>Nội dung đánh giá</th>
                        <th style="width: 120px;">Trạng thái</th>
                        <th style="width: 100px;">Thao tác</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:if="${reviewPage.empty}">
                        <td colspan="5" style="text-align: center; padding: 2rem; color: #999;">Không tìm thấy đánh giá nào.</td>
                    </tr>
                    <tr th:each="review : ${reviewPage.content}" class="review-table-row">
                        <td>
                            <div class="product-info-cell">
                                <img th:if="${review.product.images.size() > 0}" th:src="${review.product.images.iterator().next().imageUrl}" class="product-thumb">
                                <div th:unless="${review.product.images.size() > 0}" class="product-thumb" style="background: #eee;"></div>
                                <div>
                                    <a th:href="@{'/products/' + ${review.product.id}}" target="_blank" class="product-name" th:text="${review.product.name}"></a>
                                    <div class="shop-name">Shop: <span th:text="${review.product.shop.name}"></span></div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="user-info-cell">
                                <img th:if="${review.user.avatarUrl}" th:src="${review.user.avatarUrl}" class="user-avatar-small">
                                <div th:unless="${review.user.avatarUrl}" class="user-avatar-small" style="display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">
                                    <span th:text="${#strings.substring(review.user.email, 0, 1).toUpperCase()}">U</span>
                                </div>
                                <div>
                                    <div style="font-size: 0.9rem; font-weight: 500;" th:text="${review.user.fullName ?: 'No Name'}"></div>
                                    <div style="font-size: 0.75rem; color: #888;" th:text="${review.user.email}"></div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="rating-stars">
                                <span th:each="i : ${#numbers.sequence(1, 5)}" th:text="${i <= review.rating ? '★' : '☆'}" th:style="${i <= review.rating ? 'color: #ffce3d;' : 'color: #ddd;'}"></span>
                            </div>
                            <div class="review-content" th:text="${review.comment}"></div>
                            <div class="review-images-grid" th:if="${not #lists.isEmpty(review.images)}">
                                <img th:each="img : ${review.images}" th:src="${img.imageUrl}" class="review-img-small" onclick="window.open(this.src, '_blank')">
                            </div>
                        </td>
                        <td>
                            <span class="status-badge" th:classappend="${review.status.name() == 'ACTIVE' ? 'status-active' : (review.status.name() == 'HIDDEN' ? 'status-inactive' : 'status-banned')}" th:text="${review.status}"></span>
                        </td>
                        <td>
                            <form th:action="@{'/admin/reviews/' + ${review.id} + '/toggle-status'}" method="post">
                                <button th:if="${review.status.name() == 'ACTIVE'}" type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('Ẩn đánh giá này?')">Ẩn</button>
                                <button th:if="${review.status.name() == 'HIDDEN' or review.status.name() == 'DISABLED'}" type="submit" class="btn btn-outline-success btn-sm">Hiện</button>
                            </form>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <div th:if="${reviewPage.totalPages > 1}" class="pagination">
                <a th:if="${reviewPage.hasPrevious()}" th:href="@{/admin/reviews(tab='list', keyword=${keyword}, rating=${currentRating}, status=${currentStatus}, shopId=${currentShopId}, page=${reviewPage.number - 1})}">Trước</a>
                <span class="current" th:text="${reviewPage.number + 1}">1</span>
                <a th:if="${reviewPage.hasNext()}" th:href="@{/admin/reviews(tab='list', keyword=${keyword}, rating=${currentRating}, status=${currentStatus}, shopId=${currentShopId}, page=${reviewPage.number + 1})}">Sau</a>
            </div>
        </div>

        <div th:if="${currentTab == 'reports'}">
            <div class="card" style="padding: 0;">
                <table class="table">
                    <thead>
                    <tr>
                        <th style="width: 40%;">Nội dung Review</th>
                        <th style="width: 30%;">Thông tin báo cáo</th>
                        <th style="width: 30%;">Xử lý</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:if="${reportedReviews == null || reportedReviews.empty}">
                        <td colspan="3" style="text-align: center; padding: 2rem; color: #999;">Không có báo cáo nào cần xử lý.</td>
                    </tr>
                    <tr th:each="report : ${reportedReviews}">
                        <td>
                            <div style="font-weight: 600; margin-bottom: 5px;">Review ID: <span style="font-weight: normal; color: #888;" th:text="${#strings.substring(report.reviewId, 0, 8) + '...'}"></span></div>
                            <div class="review-content" th:text="${report.reviewContent}"></div>
                            <div style="margin-top: 10px; font-size: 0.85rem; color: #555;">
                                Người viết: <strong th:text="${report.reviewOwnerEmail}"></strong>
                            </div>
                        </td>

                        <td>
                            <div style="margin-bottom: 10px; color: #dc3545; font-weight: 600;">
                                ⚠️ Tổng cộng: <span th:text="${report.reportCount}"></span> báo cáo
                            </div>
                            <div th:each="detail : ${report.reports}" class="report-reason-box">
                                <strong th:text="${detail.reason}">Reason</strong>
                                <div th:if="${detail.note}" th:text="${'Ghi chú: ' + detail.note}" style="font-style: italic;"></div>
                                <div class="report-meta">
                                    Bởi: <span th:text="${detail.reporterEmail}"></span>
                                    - <span th:text="${#temporals.format(detail.createdAt, 'dd/MM HH:mm')}"></span>
                                </div>
                            </div>
                        </td>

                        <td>
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                <form th:action="@{'/admin/reviews/' + ${report.reviewId} + '/hide-report'}" method="post">
                                    <button type="submit" class="btn btn-danger btn-sm" style="width: 100%;" onclick="return confirm('Xác nhận ẩn review này và đánh dấu đã xử lý báo cáo?')">
                                        Ẩn Review (Phạt)
                                    </button>
                                </form>

                                <form th:action="@{'/admin/reviews/' + ${report.reviewId} + '/ignore-report'}" method="post">
                                    <button type="submit" class="btn btn-outline-secondary btn-sm" style="width: 100%;" onclick="return confirm('Review này hợp lệ? Bỏ qua báo cáo?')">
                                        Bỏ qua báo cáo
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</main>

<script th:src="@{/js/common.js}"></script>
<script th:src="@{/js/admin.js}"></script>
</body>
</html>