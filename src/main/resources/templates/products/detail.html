<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi Tiết Sản Phẩm - E-commerce</title>
    
    <!-- CSS -->
    <link rel="stylesheet" th:href="@{/css/base.css}">
    <link rel="stylesheet" th:href="@{/css/layout.css}">
    <link rel="stylesheet" th:href="@{/css/components.css}">
    <style>
        .product-detail-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .breadcrumb {
            margin-bottom: 1rem;
            color: var(--text-muted);
        }

        .breadcrumb a {
            color: var(--primary-color);
        }

        .product-detail {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            background: var(--bg-white);
            padding: 2rem;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-sm);
            margin-bottom: 2rem;
        }

        .product-images {
            position: relative;
        }

        .product-main-image {
            width: 100%;
            height: 500px;
            object-fit: cover;
            border-radius: var(--border-radius);
            background: #f0f0f0;
            margin-bottom: 1rem;
        }

        .product-thumbnails {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .product-thumbnail {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: var(--border-radius);
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.3s;
        }

        .product-thumbnail:hover,
        .product-thumbnail.active {
            border-color: var(--primary-color);
        }

        .product-info h1 {
            margin-top: 0;
            margin-bottom: 1rem;
        }

        .product-price {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
            margin: 1rem 0;
        }

        .product-description {
            margin: 1.5rem 0;
            line-height: 1.6;
            color: var(--text-color);
        }

        .product-variants {
            margin: 1.5rem 0;
        }

        .variant-group {
            margin-bottom: 1rem;
        }

        .variant-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .variant-options {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .variant-option {
            padding: 0.5rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.3s;
            background: var(--bg-white);
        }

        .variant-option:hover {
            border-color: var(--primary-color);
        }

        .variant-option.selected {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .variant-option.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .product-actions {
            margin: 2rem 0;
        }

        .product-actions button {
            width: 100%;
            padding: 1rem;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .product-meta {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border-color);
        }

        .product-meta-item {
            margin-bottom: 0.5rem;
            color: var(--text-muted);
        }

        .product-meta-item strong {
            color: var(--text-color);
        }

        .shop-info {
            background: var(--bg-white);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-sm);
            margin-top: 2rem;
        }

        .shop-info h3 {
            margin-top: 0;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .error {
            text-align: center;
            padding: 3rem;
            color: var(--danger-color);
        }

        @media (max-width: 768px) {
            .product-detail {
                grid-template-columns: 1fr;
            }

            .product-main-image {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <th:block th:replace="~{fragments/header :: header-simple}"></th:block>
    
    <!-- Navigation -->
    <th:block th:replace="~{fragments/nav-home :: nav-home}"></th:block>

    <!-- Main Content -->
    <main class="main-content">
        <div class="product-detail-container">
            <div class="breadcrumb">
                <a href="/">Trang chủ</a> / 
                <a href="/products">Sản phẩm</a> / 
                <span id="productBreadcrumb">Chi tiết</span>
            </div>

            <div th:if="${product != null}" class="product-detail" th:with="thumbnailImage=${product.images != null and !product.images.empty ? product.images.?[isThumbnail == true] : null}, 
                                                          firstImage=${product.images != null and !product.images.empty ? product.images[0] : null},
                                                          displayImage=${thumbnailImage != null and !thumbnailImage.empty ? thumbnailImage[0] : firstImage}">
                <div class="product-images">
                    <div class="main-image">
                        <img th:src="${displayImage != null ? displayImage.imageUrl : '/images/placeholder.png'}" 
                            th:alt="${product.name}"
                            id="mainImage"
                            class="product-main-image"
                            onerror="this.src='/images/placeholder.png'">
                    </div>
                    <div class="product-thumbnails" th:if="${product.images != null and product.images.size() > 1}">
                        <img th:each="img, iterStat : ${product.images}" 
                             th:src="${img.imageUrl}" 
                             th:alt="${product.name}"
                             th:classappend="${iterStat.first} ? 'active' : ''"
                             class="product-thumbnail"
                             th:attr="onclick=|changeMainImage('${img.imageUrl}', this)|">
                    </div>
                </div>
                
                <div class="product-info">
                    <h1 th:text="${product.name}">Product Name</h1>
                    <div class="product-price" th:text="${#numbers.formatDecimal(product.basePrice, 0, 'POINT', 0, 'POINT')} + ' VNĐ'">0 VNĐ</div>
                    <div class="product-shop">
                        <span>Shop: </span>
                        <a th:href="@{'/products?shopId=' + ${product.shopId}}" th:text="${product.shopName}">Shop Name</a>
                    </div>
                    <div class="product-description" th:utext="${product.description}">Description</div>
                    
                    <!-- Variants -->
                    <div th:if="${variantGroups != null and !variantGroups.empty}" class="product-variants">
                        <h3>Lựa chọn:</h3>
                        <div th:each="variantGroup : ${variantGroups}">
                            <label th:text="${variantGroup.key}">Variant Name</label>
                            <div class="variant-options">
                                <div th:each="variant : ${variantGroup.value}" 
                                     class="variant-option"
                                     th:classappend="${variant.stockQuantity == 0} ? 'disabled' : ''"
                                     th:attr="data-variant-id=${variant.id}, 
                                             data-variant-name=${variant.name}, 
                                             data-variant-value=${variant.value},
                                             data-stock-quantity=${variant.stockQuantity}"
                                     onclick="handleVariantClick(this)"
                                     th:text="${variant.value} + (${variant.stockQuantity == 0} ? ' (Hết hàng)' : '')">
                                    Variant Value
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="product-actions">
                        <form id="addToCartForm" th:action="@{/cart/add}" method="post" th:if="${currentUser != null}">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <input type="hidden" name="productId" th:value="${product.id}"/>
                            <input type="hidden" id="variantIdInput" name="variantId" value="">
                            <input type="hidden" name="quantity" value="1">
                            <button type="button" class="btn btn-primary" id="addToCartBtn" onclick="addToCart()">Thêm vào giỏ hàng</button>
                        </form>
                        <div th:if="${currentUser == null}">
                            <a th:href="@{'/login?redirect=/products/' + ${product.id}}" class="btn btn-primary">Đăng nhập để mua hàng</a>
                        </div>
                    </div>
                </div>
            </div>
            <div th:if="${product == null}" class="error">
                Sản phẩm không tồn tại hoặc chưa được xuất bản.
            </div>
        </div>
    </main>

    <!-- Footer -->
    <th:block th:replace="~{fragments/footer :: footer}"></th:block>

    <!-- JavaScript -->
    <script th:src="@{/js/common.js}"></script>
    <script>
        let productId = /*[[${product != null ? product.id : null}]]*/ null;
        let selectedVariants = {}; // {variantName: variantValue}
        let selectedVariantIds = {}; // {variantName: variantId}
        let productData = /*[[${product}]]*/ null;

        function displayProductDetail(product) {
            const container = document.getElementById('productDetail');
            document.getElementById('productBreadcrumb').textContent = product.name;

            const thumbnail = product.images && product.images.length > 0 
                ? product.images.find(img => img.isThumbnail) || product.images[0]
                : null;
            const mainImageUrl = thumbnail ? thumbnail.imageUrl : '/images/placeholder.png';

            // Group variants by name
            const variantGroups = {};
            if (product.variants && product.variants.length > 0) {
                product.variants.forEach(variant => {
                    if (!variantGroups[variant.name]) {
                        variantGroups[variant.name] = [];
                    }
                    variantGroups[variant.name].push(variant);
                });
            }

            let variantHTML = '';
            if (Object.keys(variantGroups).length > 0) {
                variantHTML = Object.entries(variantGroups).map(([name, variants]) => {
                    const options = variants.map((variant, index) => {
                        const stockStatus = variant.stockQuantity > 0 ? '' : 'disabled';
                        return `
                            <div class="variant-option ${stockStatus}" 
                                 data-variant-id="${variant.id}"
                                 data-name="${escapeHtml(name)}"
                                 data-value="${escapeHtml(variant.value)}"
                                 onclick="selectVariant('${name}', '${variant.value}', ${variant.stockQuantity > 0})">
                                ${escapeHtml(variant.value)} ${variant.stockQuantity > 0 ? '' : '(Hết hàng)'}
                            </div>
                        `;
                    }).join('');

                    return `
                        <div class="variant-group">
                            <label>${escapeHtml(name)}:</label>
                            <div class="variant-options">${options}</div>
                        </div>
                    `;
                }).join('');
            }

            const imagesHTML = product.images && product.images.length > 0
                ? product.images.map((img, index) => `
                    <img src="${img.imageUrl}" 
                         alt="Product image ${index + 1}" 
                         class="product-thumbnail ${index === 0 ? 'active' : ''}"
                         onclick="changeMainImage('${img.imageUrl}', this)">
                `).join('')
                : '';

            container.innerHTML = `
                <div class="product-detail">
                    <div class="product-images">
                        <img src="${mainImageUrl}" alt="${escapeHtml(product.name)}" class="product-main-image" id="mainImage" onerror="this.src='/images/placeholder.png'">
                        ${imagesHTML ? `<div class="product-thumbnails">${imagesHTML}</div>` : ''}
                    </div>

                    <div class="product-info">
                        <h1>${escapeHtml(product.name)}</h1>
                        <div class="product-price">${formatPrice(product.basePrice)} VNĐ</div>
                        
                        ${variantHTML ? `<div class="product-variants">${variantHTML}</div>` : ''}

                        <div class="product-description">
                            ${product.description ? escapeHtml(product.description).replace(/\n/g, '<br>') : 'Chưa có mô tả'}
                        </div>

                        <div class="product-meta">
                            <div class="product-meta-item">
                                <strong>SKU:</strong> ${escapeHtml(product.sku)}
                            </div>
                            <div class="product-meta-item">
                                <strong>Shop:</strong> ${escapeHtml(product.shopName || 'N/A')}
                            </div>
                            ${product.categoryName ? `
                                <div class="product-meta-item">
                                    <strong>Danh mục:</strong> ${escapeHtml(product.categoryName)}
                                </div>
                            ` : ''}
                        </div>

                        <div class="product-actions">
                            <button class="btn btn-primary" onclick="addToCart()" id="addToCartBtn">
                                Thêm vào giỏ hàng
                            </button>
                            <button class="btn btn-secondary" onclick="window.location.href='/products'">
                                Quay lại danh sách
                            </button>
                        </div>
                    </div>
                </div>

                <div class="shop-info">
                    <h3>Thông tin shop</h3>
                    <p><strong>${escapeHtml(product.shopName || 'N/A')}</strong></p>
                    <button class="btn btn-outline-secondary" onclick="viewShop('${product.shopId}')">
                        Xem shop
                    </button>
                </div>
            `;

            // Initialize variant selection
            if (Object.keys(variantGroups).length > 0) {
                // Auto-select first available variant for each group
                Object.keys(variantGroups).forEach(name => {
                    const firstAvailable = variantGroups[name].find(v => v.stockQuantity > 0);
                    if (firstAvailable) {
                        selectVariant(name, firstAvailable.value, true);
                    }
                });
            }
        }

        function changeMainImage(imageUrl, thumbnail) {
            document.getElementById('mainImage').src = imageUrl;
            document.querySelectorAll('.product-thumbnail').forEach(img => {
                img.classList.remove('active');
            });
            thumbnail.classList.add('active');
        }

        function handleVariantClick(element) {
            const stockQuantity = parseInt(element.dataset.stockQuantity || '0');
            if (stockQuantity <= 0) {
                return; // Disabled variant
            }

            const name = element.dataset.variantName;
            const value = element.dataset.variantValue;
            const variantId = element.dataset.variantId;

            selectVariant(name, value, variantId, true);
        }

        function selectVariant(name, value, variantId, available) {
            if (!available) return;

            const options = document.querySelectorAll(`[data-variant-name="${name}"]`);
            options.forEach(opt => {
                opt.classList.remove('selected');
            });

            const selectedOption = Array.from(options).find(opt => opt.dataset.variantValue === value);
            if (selectedOption) {
                selectedOption.classList.add('selected');
            }

            selectedVariants[name] = value;
            selectedVariantIds[name] = variantId;
            updateAddToCartButton();
        }

        function updateAddToCartButton() {
            const btn = document.getElementById('addToCartBtn');
            if (!btn) return;

            // Check if all variant groups have a selection
            if (productData && productData.variants && productData.variants.length > 0) {
                const variantGroups = {};
                productData.variants.forEach(v => {
                    if (!variantGroups[v.name]) {
                        variantGroups[v.name] = true;
                    }
                });

                const allSelected = Object.keys(variantGroups).every(name => selectedVariants[name]);
                if (!allSelected) {
                    btn.textContent = 'Vui lòng chọn đầy đủ thuộc tính';
                    btn.disabled = true;
                    return;
                }
            }

            btn.textContent = 'Thêm vào giỏ hàng';
            btn.disabled = false;
        }

        function addToCart() {
            // This function is called from the button click
            const form = document.getElementById('addToCartForm');
            if (!form) {
                // User not logged in
                if (confirm('Bạn cần đăng nhập để thêm sản phẩm vào giỏ hàng. Đi đến trang đăng nhập?')) {
                    window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
                }
                return;
            }

            // Check if product has variants and all are selected
            if (productData && productData.variants && productData.variants.length > 0) {
                const variantGroups = {};
                productData.variants.forEach(v => {
                    if (!variantGroups[v.name]) {
                        variantGroups[v.name] = true;
                    }
                });

                const allSelected = Object.keys(variantGroups).every(name => selectedVariants[name]);
                if (!allSelected) {
                    alert('Vui lòng chọn đầy đủ thuộc tính sản phẩm.');
                    return;
                }

                // For now, we'll use the first selected variant ID
                // In a more complex system, you might need to find a combination variant
                // But based on the current schema, each variant is independent
                // So we'll just use the first one selected
                const firstVariantId = Object.values(selectedVariantIds)[0];
                if (firstVariantId) {
                    document.getElementById('variantIdInput').value = firstVariantId;
                } else {
                    // Fallback: try to find variant by selected values
                    const matchingVariant = productData.variants.find(v => {
                        return selectedVariants[v.name] === v.value;
                    });
                    if (matchingVariant) {
                        document.getElementById('variantIdInput').value = matchingVariant.id;
                    } else {
                        alert('Không tìm thấy biến thể phù hợp. Vui lòng thử lại.');
                        return;
                    }
                }
            } else {
                // No variants, clear variantId
                document.getElementById('variantIdInput').value = '';
            }

            // Submit form
            form.submit();
        }

        function viewShop(shopId) {
            // TODO: Implement shop view page
            alert('Trang shop sẽ được triển khai sau.');
        }

        function formatPrice(price) {
            return new Intl.NumberFormat('vi-VN').format(price);
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
