<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lịch Sử Đơn Hàng - E-commerce</title>
    
    <link rel="stylesheet" th:href="@{/css/base.css}">
    <link rel="stylesheet" th:href="@{/css/layout.css}">
    <link rel="stylesheet" th:href="@{/css/components.css}">
</head>
<body>
    <th:block th:replace="~{fragments/header :: header-simple}"></th:block>
    <th:block th:replace="~{fragments/nav-home :: nav-home}"></th:block>

    <main class="main-content">
        <div class="container">
            <div class="orders-container">
                <div class="page-title">
                    <h1>Lịch Sử Đơn Hàng</h1>
                    <p class="subtitle">Theo dõi đơn hàng của bạn</p>
                </div>

        <div th:if="${orders == null or orders.isEmpty()}" class="empty-state">
            <p>Bạn chưa có đơn hàng nào.</p>
            <a href="/products" class="btn btn-primary">Mua Sắm Ngay</a>
        </div>

        <div th:if="${orders != null and !orders.isEmpty()}">
            <div th:each="order : ${orders}" class="order-card">
                <div class="order-header">
                    <div>
                        <h3 th:text="'Đơn hàng: ' + ${order.orderNumber}">Order Number</h3>
                        <p class="mb-2" style="color: var(--text-muted);" 
                           th:text="'Ngày đặt: ' + ${#temporals.format(order.createdAt, 'dd/MM/yyyy HH:mm')}">Date</p>
                    </div>
                    <span class="order-status" 
                          th:classappend="'status-' + ${order.status}"
                          th:text="${order.status}">Status</span>
                </div>

                <div class="order-items-list">
                    <div th:each="item : ${order.items}" class="order-item-row">
                        <img th:src="${item.productImageUrl != null ? item.productImageUrl : '/images/placeholder.png'}"
                             class="item-img" alt="Sản phẩm">

                        <div class="item-details">
                            <a th:href="@{'/products/' + ${item.productId}}" class="item-name" th:text="${item.productName}">Tên sản phẩm</a>
                            <div class="item-variant" th:if="${item.variantName != null}">
                                Phân loại: <span th:text="${item.variantName} + ' ' + ${item.variantValue}">Màu sắc</span>
                            </div>
                            <div class="item-variant">x<span th:text="${item.quantity}">1</span></div>
                        </div>

                        <div class="item-price-action">
                            <div class="price-text" th:text="${#numbers.formatDecimal(item.unitPrice, 0, 'POINT', 0, 'POINT')} + ' ₫'">100.000 ₫</div>

                            <th:block th:if="${order.status.name() == 'DELIVERED'}">
                                <a th:if="${!item.isReviewed}"
                                   th:href="@{'/products/' + ${item.productId} + '/review?subOrderId=' + ${order.id}}"
                                   class="btn-rate-shopee">
                                    Đánh Giá
                                </a>

                                <a th:if="${item.isReviewed}"
                                   th:href="@{'/reviews/my-review?productId=' + ${item.productId} + '&subOrderId=' + ${order.id}}"
                                   class="btn btn-sm btn-outline-secondary"
                                   style="border: 1px solid #ddd; color: #555; background: #fff;">
                                    Xem Đánh Giá
                                </a>
                            </th:block>
                        </div>
                    </div>
                </div>

                <div class="order-info">
                    <div class="order-info-item">
                        <label>Shop:</label>
                        <span th:text="${order.shopName}">Shop Name</span>
                    </div>
                    <div class="order-info-item">
                        <label>Tổng tiền:</label>
                        <span th:text="${#numbers.formatDecimal(order.total, 0, 'POINT', 0, 'POINT')} + ' VNĐ'">Total</span>
                    </div>
                    <div class="order-info-item">
                        <label>Số sản phẩm:</label>
                        <span th:text="${order.items != null ? order.items.size() : 0}">Items</span>
                    </div>
                </div>

                <div class="order-actions">
                    <a th:href="@{'/orders/' + ${order.id}}" class="btn btn-outline-primary">Xem Chi Tiết</a>
                    <a th:if="${order.status.name() == 'PENDING_PAYMENT'}"
                       th:href="@{'/payments/' + ${order.id}}"
                       class="btn btn-warning">
                        Tiếp tục thanh toán
                    </a>

                    <form th:if="${order.status.name() == 'PENDING_PAYMENT' or order.status.name() == 'CONFIRMED'}"
                          th:action="@{'/orders/' + ${order.id} + '/cancel'}" 
                          method="post" style="display: inline;">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <button type="submit" class="btn btn-outline-danger"
                                onclick="return confirm('Bạn có chắc muốn hủy đơn hàng này?')">
                            Hủy Đơn
                        </button>
                    </form>
                </div>
            </div>
        </div>
            </div>
        </div>
    </main>

    <th:block th:replace="~{fragments/footer :: footer}"></th:block>
    <script th:src="@{/js/common.js}"></script>
</body>
</html>