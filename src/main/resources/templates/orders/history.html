<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L·ªãch S·ª≠ ƒê∆°n H√†ng - E-commerce</title>
    
    <link rel="stylesheet" th:href="@{/css/base.css}">
    <link rel="stylesheet" th:href="@{/css/layout.css}">
    <link rel="stylesheet" th:href="@{/css/components.css}">
    <style>
        .order-actions-flex {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-top: 12px;
        }

        .order-actions-left {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .order-actions-right {
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
        }

        .receive-status.success {
            color: #2e7d32;
        }

        .receive-status.pending {
            color: #ff9800;
        }

    </style>
</head>
<body>
    <th:block th:replace="~{fragments/header :: header-simple}"></th:block>
    <th:block th:replace="~{fragments/nav-home :: nav-home}"></th:block>

    <main class="main-content">
        <div class="container">
            <div class="orders-container">
                <div class="page-title">
                    <h1>L·ªãch S·ª≠ ƒê∆°n H√†ng</h1>
                    <p class="subtitle">Theo d√µi ƒë∆°n h√†ng c·ªßa b·∫°n</p>
                </div>

        <div th:if="${orders == null or orders.isEmpty()}" class="empty-state">
            <p>B·∫°n ch∆∞a c√≥ ƒë∆°n h√†ng n√†o.</p>
            <a href="/products" class="btn btn-primary">Mua S·∫Øm Ngay</a>
        </div>

        <div th:if="${orders != null and !orders.isEmpty()}">
            <div th:each="order : ${orders}" class="order-card">
                <div class="order-header">
                    <div>
                        <h3 th:text="'ƒê∆°n h√†ng: ' + ${order.orderNumber}">Order Number</h3>
                        <p class="mb-2" style="color: var(--text-muted);" 
                           th:text="'Ng√†y ƒë·∫∑t: ' + ${#temporals.format(order.createdAt, 'dd/MM/yyyy HH:mm')}">Date</p>
                    </div>
                    <span class="order-status" 
                          th:classappend="'status-' + ${order.status}"
                          th:text="${order.status}">Status
                    </span>
                </div>

                <div class="order-items-list">
                    <div th:each="item : ${order.items}" class="order-item-row">
                        <img th:src="${item.productImageUrl != null ? item.productImageUrl : '/images/placeholder.png'}"
                             class="item-img" alt="S·∫£n ph·∫©m">

                        <div class="item-details">
                            <a th:href="@{'/products/' + ${item.productId}}" class="item-name" th:text="${item.productName}">T√™n s·∫£n ph·∫©m</a>
                            <div class="item-variant" th:if="${item.variantName != null}">
                                Ph√¢n lo·∫°i: <span th:text="${item.variantName} + ' ' + ${item.variantValue}">M√†u s·∫Øc</span>
                            </div>
                            <div class="item-variant">x<span th:text="${item.quantity}">1</span></div>
                        </div>

                        <div class="item-price-action">
                            <div class="price-text" th:text="${#numbers.formatDecimal(item.unitPrice, 0, 'POINT', 0, 'POINT')} + ' ‚Ç´'">100.000 ‚Ç´</div>

                            <th:block th:if="${order.status.name() == 'DELIVERED' and order.receivedByBuyer}">
                                <a th:if="${!item.isReviewed}"
                                   th:href="@{'/products/' + ${item.productId} + '/review?subOrderId=' + ${order.id}}"
                                   class="btn-rate-shopee">
                                    ƒê√°nh Gi√°
                                </a>

                                <a th:if="${item.isReviewed}"
                                   th:href="@{'/reviews/my-review?productId=' + ${item.productId} + '&subOrderId=' + ${order.id}}"
                                   class="btn btn-sm btn-outline-secondary"
                                   style="border: 1px solid #ddd; color: #555; background: #fff;">
                                    Xem ƒê√°nh Gi√°
                                </a>
                            </th:block>
                        </div>
                    </div>
                </div>

                <div class="order-info">
                    <div class="order-info-item">
                        <label>Shop:</label>
                        <span th:text="${order.shopName}">Shop Name</span>
                    </div>
                    <div class="order-info-item">
                        <label>T·ªïng ti·ªÅn:</label>
                        <span th:text="${#numbers.formatDecimal(order.total, 0, 'POINT', 0, 'POINT')} + ' VNƒê'">Total</span>
                    </div>
                    <div class="order-info-item">
                        <label>S·ªë s·∫£n ph·∫©m:</label>
                        <span th:text="${order.items != null ? order.items.size() : 0}">Items</span>
                    </div>
                </div>

                <div class="order-actions order-actions-flex">
                    <div class="order-actions-left">
                        <a th:href="@{'/orders/' + ${order.id}}" class="btn btn-outline-primary">Xem Chi Ti·∫øt</a>

                        <a th:if="${order.status.name() == 'PENDING_PAYMENT'}"
                           th:href="@{'/payments/' + ${order.id}}"
                           class="btn btn-warning">
                            Ti·∫øp t·ª•c thanh to√°n
                        </a>

                        <form th:if="${order.status.name() == 'PENDING_PAYMENT' or order.status.name() == 'CONFIRMED'}"
                              th:action="@{'/orders/' + ${order.id} + '/cancel'}"
                              method="post" style="display:inline;">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <button type="submit" class="btn btn-outline-danger">H·ªßy ƒê∆°n</button>
                        </form>

                        <form th:if="${order.status.name() == 'DELIVERED' and !order.receivedByBuyer}"
                              th:action="@{'/orders/' + ${order.id} + '/received'}"
                              method="post" style="display:inline;">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <button type="submit" class="btn btn-success">ƒê√£ nh·∫≠n h√†ng</button>
                        </form>
                    </div>

                    <!-- üëá S√ÅT PH·∫¢I -->
                    <div class="order-actions-right"
                         th:if="${order.status.name() == 'DELIVERED'}">
                        <span th:if="${order.receivedByBuyer}"
                              class="receive-status success">
                            ‚úî ƒê√£ nh·∫≠n h√†ng
                        </span>
                        <span th:if="${!order.receivedByBuyer}"
                              class="receive-status pending">
                            ‚è≥ Ch·ªù b·∫°n x√°c nh·∫≠n
                        </span>
                    </div>
                </div>

            </div>
        </div>
            </div>
        </div>
    </main>

    <th:block th:replace="~{fragments/footer :: footer}"></th:block>
    <script th:src="@{/js/common.js}"></script>
</body>
</html>