<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.parameterName}">
    <title>Thêm Sản Phẩm - E-commerce</title>
    
    <!-- CSS -->
    <link rel="stylesheet" th:href="@{/css/base.css}">
    <link rel="stylesheet" th:href="@{/css/layout.css}">
    <link rel="stylesheet" th:href="@{/css/components.css}">
    <link rel="stylesheet" th:href="@{/css/seller.css}">
</head>
<body>
    <!-- Header -->
    <th:block th:replace="~{fragments/header :: header-simple}"></th:block>
    
    <!-- Navigation -->
    <th:block th:replace="~{fragments/nav-seller :: nav-seller}"></th:block>

    <!-- Main Content -->
    <main class="main-content seller-content">
        <div class="container">
            <div class="wizard-container">
                <h2 style="margin-bottom: 2rem;">Thêm Sản Phẩm Mới</h2>

                <!-- Wizard Steps -->
                <div class="wizard-steps">
                    <div class="wizard-step active" data-step="1">
                        <div class="wizard-step-number">1</div>
                        <div class="wizard-step-label">Thông Tin & Hình Ảnh</div>
                    </div>
                    <div class="wizard-step" data-step="2">
                        <div class="wizard-step-number">2</div>
                        <div class="wizard-step-label">Biến Thể & Danh Mục</div>
                    </div>
                    <div class="wizard-step" data-step="3">
                        <div class="wizard-step-number">3</div>
                        <div class="wizard-step-label">Xem Lại & Lưu</div>
                    </div>
                </div>

                <!-- Wizard Content -->
                <form id="productForm" style="display: none;">
                    <!-- Hidden form for actual submission -->
                </form>
                    <!-- Step 1: Basic Info + Images -->
                    <div class="wizard-content" id="step1">
                        <h3>Thông Tin Cơ Bản & Hình Ảnh</h3>
                        
                        <div class="form-group">
                            <label for="productName">Tên sản phẩm *</label>
                            <input type="text" id="productName" name="name" required oninput="autoGenerateSku()">
                        </div>
                        <div class="form-group">
                            <label for="productDescription">Mô tả</label>
                            <textarea id="productDescription" name="description" rows="4"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="productSku">SKU (Mã hàng tồn kho) *</label>
                            <div style="display: flex; gap: 0.5rem; align-items: flex-start;">
                                <input type="text" id="productSku" name="sku" placeholder="VD: SHIRT-COTTON-001" required style="flex: 1;">
                                <button type="button" class="btn btn-secondary" onclick="autoGenerateSku()" style="white-space: nowrap;">Tự động tạo</button>
                            </div>
                            <small style="color: var(--text-muted); font-size: 0.875rem; display: block; margin-top: 0.5rem;">
                                <strong>SKU là gì?</strong> Mã định danh duy nhất cho sản phẩm (Stock Keeping Unit). 
                                Click "Tự động tạo" để tạo SKU từ tên sản phẩm, hoặc nhập thủ công.
                            </small>
                        </div>
                        <div class="form-group">
                            <label for="productBasePrice">Giá cơ bản (VNĐ) *</label>
                            <input type="number" id="productBasePrice" name="basePrice" min="0" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="productStatus">Trạng thái</label>
                            <select id="productStatus" name="status">
                                <option value="DRAFT">Nháp</option>
                                <option value="PUBLISHED">Xuất bản</option>
                            </select>
                        </div>

                        <hr style="margin: 2rem 0; border: none; border-top: 1px solid var(--border-color);">

                        <h4 style="margin-bottom: 1rem;">Hình Ảnh Sản Phẩm (Tùy chọn)</h4>
                        <div class="image-upload-area" id="imageUploadArea">
                            <p>Kéo thả hình ảnh vào đây hoặc click để chọn</p>
                            <input type="file" id="imageInput" multiple accept="image/*" style="display: none;">
                        </div>
                        <div class="image-preview-grid" id="imagePreviewGrid">
                            <!-- Images will be added here -->
                        </div>
                    </div>

                    <!-- Step 2: Variants + Category -->
                    <div class="wizard-content" id="step2" style="display: none;">
                        <h3>Biến Thể & Danh Mục (Tùy chọn)</h3>
                        <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
                            Bạn có thể thêm biến thể (màu sắc, size, v.v.) và chọn danh mục. Nếu không cần, có thể bỏ qua bước này.
                        </p>

                        <div style="margin-bottom: 2rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <h4 style="margin: 0;">Biến Thể Sản Phẩm</h4>
                                <button type="button" class="btn btn-secondary" onclick="addVariant()">+ Thêm Biến Thể</button>
                            </div>
                            <div class="variant-list" id="variantList">
                                <!-- Variants will be added here -->
                            </div>
                            <p style="color: var(--text-muted); font-size: 0.875rem; margin-top: 0.5rem;">
                                Biến thể giúp quản lý các phiên bản khác nhau của sản phẩm (VD: Màu đỏ Size M, Màu xanh Size L)
                            </p>
                        </div>

                        <hr style="margin: 2rem 0; border: none; border-top: 1px solid var(--border-color);">

                        <div class="form-group">
                            <label for="productCategory">Danh Mục Sản Phẩm</label>
                            <select id="productCategory" name="categoryId">
                                <option value="">-- Chọn danh mục (Tùy chọn) --</option>
                                <option th:each="category : ${categories}" 
                                        th:value="${category.id}" 
                                        th:text="${category.name}">Category Name</option>
                            </select>
                            <small style="color: var(--text-muted); font-size: 0.875rem; display: block; margin-top: 0.5rem;">
                                Chọn danh mục phù hợp để khách hàng dễ tìm thấy sản phẩm của bạn
                            </small>
                        </div>
                    </div>

                    <!-- Step 3: Review -->
                    <div class="wizard-content" id="step3" style="display: none;">
                        <h3>Xem Lại & Lưu Sản Phẩm</h3>
                        <div id="reviewContent">
                            <!-- Review content will be generated here -->
                        </div>
                    </div>

                    <!-- Wizard Actions -->
                    <div class="wizard-actions">
                        <button type="button" class="btn btn-secondary" id="prevBtn" onclick="previousStep()" style="display: none;">Quay Lại</button>
                        <div style="flex: 1;"></div>
                        <button type="button" class="btn btn-outline-secondary" id="skipBtn" onclick="skipToReview()" style="display: none;">Bỏ qua & Xem lại</button>
                        <button type="button" class="btn btn-success" id="saveNowBtn" onclick="saveProductNow()" style="display: none;">Lưu ngay (Nháp)</button>
                        <button type="button" class="btn btn-primary" id="nextBtn" onclick="nextStep()">Tiếp Theo</button>
                        <button type="button" class="btn btn-success" id="submitBtn" onclick="submitProduct()" style="display: none;">Lưu Sản Phẩm</button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <!-- JavaScript -->
    <script th:src="@{/js/common.js}"></script>
    <script>
        let currentStep = 1;
        const totalSteps = 3;
        let productData = {
            name: '',
            description: '',
            sku: '',
            basePrice: 0,
            status: 'DRAFT',
            images: [],
            variants: [],
            categoryId: null
        };

        document.addEventListener('DOMContentLoaded', function() {
            // Setup image upload
            setupImageUpload();
            
            // Auto-generate SKU on page load if name exists
            const nameInput = document.getElementById('productName');
            if (nameInput.value) {
                autoGenerateSku();
            }
        });

        function autoGenerateSku() {
            const nameInput = document.getElementById('productName');
            const skuInput = document.getElementById('productSku');
            const productName = nameInput.value.trim();
            
            if (productName) {
                // Convert Vietnamese to ASCII, remove special chars, uppercase
                let sku = productName
                    .normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, '') // Remove diacritics
                    .replace(/[^a-zA-Z0-9\s]/g, '') // Remove special chars
                    .replace(/\s+/g, '-') // Replace spaces with hyphens
                    .toUpperCase()
                    .substring(0, 50); // Limit length
                
                // Add timestamp suffix to make it unique
                const timestamp = Date.now().toString().slice(-6);
                sku = sku + '-' + timestamp;
                
                skuInput.value = sku;
            }
        }

        function setupImageUpload() {
            const uploadArea = document.getElementById('imageUploadArea');
            const imageInput = document.getElementById('imageInput');

            uploadArea.addEventListener('click', () => imageInput.click());
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });

            imageInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
        }

        async function handleFiles(files) {
            for (let file of files) {
                if (!file.type.startsWith('image/')) continue;
                
                // Upload file to server
                const formData = new FormData();
                formData.append('file', file);

                try {
                    // Get CSRF token from meta tag or hidden input
                    const csrfToken = document.querySelector('meta[name="_csrf"]')?.content || 
                                     document.querySelector('input[name="_csrf"]')?.value;
                    if (csrfToken) {
                        formData.append('_csrf', csrfToken);
                    }
                    
                    const response = await fetch('/files/upload', {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        const data = await response.json();
                        addImagePreview(data.url);
                    } else {
                        alert('Lỗi khi upload ảnh: ' + file.name);
                    }
                } catch (error) {
                    alert('Lỗi khi upload ảnh: ' + file.name);
                }
            }
        }

        function addImagePreview(imageUrl) {
            const previewGrid = document.getElementById('imagePreviewGrid');
            const imageIndex = productData.images.length;
            
            productData.images.push({
                imageUrl: imageUrl,
                isThumbnail: imageIndex === 0,
                displayOrder: imageIndex
            });

            const imageItem = document.createElement('div');
            imageItem.className = 'image-preview-item';
            imageItem.innerHTML = `
                <img src="${imageUrl}" alt="Preview">
                ${imageIndex === 0 ? '<span class="thumbnail-badge">Thumbnail</span>' : ''}
                <div class="image-actions">
                    <button type="button" class="btn btn-sm btn-primary" onclick="setThumbnail(${imageIndex})">Đặt làm ảnh đại diện</button>
                    <button type="button" class="btn btn-sm btn-danger" onclick="removeImage(${imageIndex})">Xóa</button>
                </div>
            `;
            previewGrid.appendChild(imageItem);
        }

        function setThumbnail(index) {
            productData.images.forEach((img, i) => {
                img.isThumbnail = (i === index);
            });
            updateImagePreviews();
        }

        function removeImage(index) {
            productData.images.splice(index, 1);
            updateImagePreviews();
        }

        function updateImagePreviews() {
            const previewGrid = document.getElementById('imagePreviewGrid');
            previewGrid.innerHTML = '';
            productData.images.forEach((img, index) => {
                const imageItem = document.createElement('div');
                imageItem.className = 'image-preview-item';
                imageItem.innerHTML = `
                    <img src="${img.imageUrl}" alt="Preview">
                    ${img.isThumbnail ? '<span class="thumbnail-badge">Thumbnail</span>' : ''}
                    <div class="image-actions">
                        <button type="button" class="btn btn-sm btn-primary" onclick="setThumbnail(${index})">Đặt làm ảnh đại diện</button>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeImage(${index})">Xóa</button>
                    </div>
                `;
                previewGrid.appendChild(imageItem);
            });
        }

        function addVariant() {
            const variantList = document.getElementById('variantList');
            const variantIndex = productData.variants.length;
            
            const variantItem = document.createElement('div');
            variantItem.className = 'variant-item';
            variantItem.innerHTML = `
                <div class="variant-item-header">
                    <h4>Biến Thể ${variantIndex + 1}</h4>
                    <button type="button" class="btn btn-sm btn-danger" onclick="removeVariant(${variantIndex})">Xóa</button>
                </div>
                <div class="variant-fields">
                    <div class="form-group">
                        <label>Tên thuộc tính * (VD: Màu sắc, Size)</label>
                        <input type="text" class="variant-name" placeholder="Màu sắc" required>
                    </div>
                    <div class="form-group">
                        <label>Giá trị * (VD: Đỏ, XL)</label>
                        <input type="text" class="variant-value" placeholder="Đỏ" required>
                    </div>
                    <div class="form-group">
                        <label>Giá chênh lệch (VNĐ)</label>
                        <input type="number" class="variant-price-modifier" value="0" step="0.01" placeholder="0">
                        <small style="color: var(--text-muted); font-size: 0.875rem; display: block; margin-top: 0.5rem;">
                            Số tiền chênh lệch so với giá cơ bản. Ví dụ: Giá cơ bản 200,000 VNĐ, chênh lệch +20,000 VNĐ → Giá variant = 220,000 VNĐ
                        </small>
                    </div>
                    <div class="form-group">
                        <label>Số lượng tồn kho *</label>
                        <input type="number" class="variant-stock" value="0" min="0" required>
                    </div>
                    <div class="form-group">
                        <label>SKU Variant (Mã biến thể) *</label>
                        <input type="text" class="variant-sku" placeholder="VD: SHIRT-001-RED-M, SHOE-002-BLACK-42" required>
                        <small style="color: var(--text-muted); font-size: 0.875rem; display: block; margin-top: 0.5rem;">
                            Mã SKU riêng cho biến thể này. Thường kết hợp SKU sản phẩm + thuộc tính.
                            <br>Ví dụ: Nếu Product SKU là "SHIRT-001", variant "Đỏ, Size M" có thể là "SHIRT-001-RED-M"
                        </small>
                    </div>
                </div>
            `;
            variantList.appendChild(variantItem);
        }

        function removeVariant(index) {
            productData.variants.splice(index, 1);
            updateVariantList();
        }

        function updateVariantList() {
            const variantList = document.getElementById('variantList');
            variantList.innerHTML = '';
            productData.variants.forEach((variant, index) => {
                const variantItem = document.createElement('div');
                variantItem.className = 'variant-item';
                variantItem.innerHTML = `
                    <div class="variant-item-header">
                        <h4>Biến Thể ${index + 1}</h4>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeVariant(${index})">Xóa</button>
                    </div>
                    <div class="variant-fields">
                        <div class="form-group">
                            <label>Tên thuộc tính *</label>
                            <input type="text" class="variant-name" value="${variant.name}" required>
                        </div>
                        <div class="form-group">
                            <label>Giá trị *</label>
                            <input type="text" class="variant-value" value="${variant.value}" required>
                        </div>
                        <div class="form-group">
                            <label>Giá chênh lệch (VNĐ)</label>
                            <input type="number" class="variant-price-modifier" value="${variant.priceModifier}" step="0.01" placeholder="0">
                            <small style="color: var(--text-muted); font-size: 0.875rem; display: block; margin-top: 0.5rem;">
                                Số tiền chênh lệch so với giá cơ bản. Ví dụ: +20,000 VNĐ hoặc -10,000 VNĐ
                            </small>
                        </div>
                        <div class="form-group">
                            <label>Số lượng tồn kho *</label>
                            <input type="number" class="variant-stock" value="${variant.stockQuantity}" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>SKU Variant (Mã biến thể) *</label>
                            <input type="text" class="variant-sku" value="${variant.sku}" placeholder="VD: SHIRT-001-RED-M" required>
                            <small style="color: var(--text-muted); font-size: 0.875rem; display: block; margin-top: 0.5rem;">
                                Mã SKU riêng cho biến thể này. Thường kết hợp SKU sản phẩm + thuộc tính.
                            </small>
                        </div>
                    </div>
                `;
                variantList.appendChild(variantItem);
            });
        }

        function collectStepData() {
            if (currentStep === 1) {
                productData.name = document.getElementById('productName').value;
                productData.description = document.getElementById('productDescription').value;
                productData.sku = document.getElementById('productSku').value;
                productData.basePrice = parseFloat(document.getElementById('productBasePrice').value);
                productData.status = document.getElementById('productStatus').value;
            } else if (currentStep === 2) {
                // Collect variants
                productData.variants = [];
                const variantItems = document.querySelectorAll('.variant-item');
                variantItems.forEach(item => {
                    productData.variants.push({
                        name: item.querySelector('.variant-name').value,
                        value: item.querySelector('.variant-value').value,
                        priceModifier: parseFloat(item.querySelector('.variant-price-modifier').value) || 0,
                        stockQuantity: parseInt(item.querySelector('.variant-stock').value) || 0,
                        sku: item.querySelector('.variant-sku').value
                    });
                });
                
                // Collect category
                const categorySelect = document.getElementById('productCategory');
                productData.categoryId = categorySelect.value || null;
            }
        }

        function nextStep() {
            if (currentStep < totalSteps) {
                collectStepData();
                
                // Validate current step
                if (!validateStep(currentStep)) {
                    return;
                }

                // Hide current step
                document.getElementById(`step${currentStep}`).style.display = 'none';
                document.querySelector(`.wizard-step[data-step="${currentStep}"]`).classList.remove('active');

                // Show next step
                currentStep++;
                document.getElementById(`step${currentStep}`).style.display = 'block';
                document.querySelector(`.wizard-step[data-step="${currentStep}"]`).classList.add('active', 'completed');

                // Update buttons
                document.getElementById('prevBtn').style.display = 'inline-block';
                if (currentStep === 1) {
                    document.getElementById('saveNowBtn').style.display = 'inline-block';
                    document.getElementById('skipBtn').style.display = 'none';
                } else if (currentStep === 2) {
                    document.getElementById('saveNowBtn').style.display = 'none';
                    document.getElementById('skipBtn').style.display = 'inline-block';
                } else if (currentStep === totalSteps) {
                    document.getElementById('nextBtn').style.display = 'none';
                    document.getElementById('submitBtn').style.display = 'inline-block';
                    document.getElementById('skipBtn').style.display = 'none';
                    document.getElementById('saveNowBtn').style.display = 'none';
                    generateReview();
                } else {
                    document.getElementById('nextBtn').style.display = 'inline-block';
                    document.getElementById('submitBtn').style.display = 'none';
                    document.getElementById('skipBtn').style.display = 'none';
                    document.getElementById('saveNowBtn').style.display = 'none';
                }
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                collectStepData();

                // Hide current step
                document.getElementById(`step${currentStep}`).style.display = 'none';
                document.querySelector(`.wizard-step[data-step="${currentStep}"]`).classList.remove('active');

                // Show previous step
                currentStep--;
                document.getElementById(`step${currentStep}`).style.display = 'block';
                document.querySelector(`.wizard-step[data-step="${currentStep}"]`).classList.add('active');
                document.querySelector(`.wizard-step[data-step="${currentStep + 1}"]`).classList.remove('completed');

                // Update buttons
                if (currentStep === 1) {
                    document.getElementById('prevBtn').style.display = 'none';
                    document.getElementById('saveNowBtn').style.display = 'inline-block';
                    document.getElementById('skipBtn').style.display = 'none';
                } else if (currentStep === 2) {
                    document.getElementById('skipBtn').style.display = 'inline-block';
                    document.getElementById('saveNowBtn').style.display = 'none';
                }
                document.getElementById('nextBtn').style.display = 'inline-block';
                document.getElementById('submitBtn').style.display = 'none';
            }
        }

        function skipToReview() {
            collectStepData();
            // Skip to review step
            document.getElementById(`step${currentStep}`).style.display = 'none';
            document.querySelector(`.wizard-step[data-step="${currentStep}"]`).classList.remove('active');
            
            currentStep = totalSteps;
            document.getElementById(`step${currentStep}`).style.display = 'block';
            document.querySelector(`.wizard-step[data-step="${currentStep}"]`).classList.add('active', 'completed');
            
            // Update buttons
            document.getElementById('prevBtn').style.display = 'inline-block';
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('submitBtn').style.display = 'inline-block';
            document.getElementById('skipBtn').style.display = 'none';
            document.getElementById('saveNowBtn').style.display = 'none';
            
            generateReview();
        }

        function saveProductNow() {
            collectStepData();
            
            if (!validateStep(1)) {
                return;
            }

            // Set status to DRAFT
            productData.status = 'DRAFT';
            
            // Submit form with DRAFT status
            submitProductForm('DRAFT');
        }
        
        function submitProductForm(status) {
            collectStepData();
            productData.status = status || productData.status;
            
            // Create a form and submit it
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/seller/products/add';
            form.enctype = 'application/x-www-form-urlencoded';
            
            // Add CSRF token
            const csrfToken = document.querySelector('meta[name="_csrf"]')?.content || 
                             document.querySelector('input[name="_csrf"]')?.value;
            if (csrfToken) {
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = '_csrf';
                csrfInput.value = csrfToken;
                form.appendChild(csrfInput);
            }
            
            // Add basic product fields
            if (productData.name) {
                addInput(form, 'name', productData.name);
            }
            if (productData.description) {
                addInput(form, 'description', productData.description);
            }
            if (productData.sku) {
                addInput(form, 'sku', productData.sku);
            }
            if (productData.basePrice) {
                addInput(form, 'basePrice', productData.basePrice);
            }
            if (productData.status) {
                addInput(form, 'status', productData.status);
            }
            if (productData.categoryId) {
                addInput(form, 'categoryId', productData.categoryId);
            }
            
            // Add variants with proper Spring MVC array format
            if (productData.variants && productData.variants.length > 0) {
                productData.variants.forEach((variant, index) => {
                    if (variant.name) addInput(form, `variants[${index}].name`, variant.name);
                    if (variant.value) addInput(form, `variants[${index}].value`, variant.value);
                    if (variant.sku) addInput(form, `variants[${index}].sku`, variant.sku);
                    if (variant.priceModifier !== undefined) addInput(form, `variants[${index}].priceModifier`, variant.priceModifier);
                    if (variant.stockQuantity !== undefined) addInput(form, `variants[${index}].stockQuantity`, variant.stockQuantity);
                });
            }
            
            // Add images with proper Spring MVC array format
            if (productData.images && productData.images.length > 0) {
                productData.images.forEach((image, index) => {
                    if (image.imageUrl) addInput(form, `images[${index}].imageUrl`, image.imageUrl);
                    if (image.isThumbnail !== undefined) addInput(form, `images[${index}].isThumbnail`, image.isThumbnail);
                    if (image.displayOrder !== undefined) addInput(form, `images[${index}].displayOrder`, image.displayOrder);
                });
            }
            
            document.body.appendChild(form);
            form.submit();
        }
        
        function addInput(form, name, value) {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = name;
            input.value = value;
            form.appendChild(input);
        }

        function validateStep(step) {
            if (step === 1) {
                const name = document.getElementById('productName').value.trim();
                const sku = document.getElementById('productSku').value.trim();
                const basePrice = document.getElementById('productBasePrice').value;

                if (!name) {
                    alert('Vui lòng nhập tên sản phẩm');
                    return false;
                }
                if (!sku) {
                    alert('Vui lòng nhập SKU');
                    return false;
                }
                if (!basePrice || parseFloat(basePrice) <= 0) {
                    alert('Vui lòng nhập giá hợp lệ');
                    return false;
                }
            } else if (step === 2) {
                // Validate variants if any
                const variantItems = document.querySelectorAll('.variant-item');
                for (let item of variantItems) {
                    const name = item.querySelector('.variant-name').value.trim();
                    const value = item.querySelector('.variant-value').value.trim();
                    const sku = item.querySelector('.variant-sku').value.trim();
                    const stock = item.querySelector('.variant-stock').value;

                    if (!name || !value || !sku) {
                        alert('Vui lòng điền đầy đủ thông tin biến thể');
                        return false;
                    }
                    if (!stock || parseInt(stock) < 0) {
                        alert('Số lượng tồn kho phải >= 0');
                        return false;
                    }
                }
            }
            return true;
        }

        function generateReview() {
            collectStepData();
            const reviewContent = document.getElementById('reviewContent');
            
            let html = `
                <div class="review-section">
                    <h4>Thông Tin Cơ Bản</h4>
                    <p><strong>Tên:</strong> ${escapeHtml(productData.name)}</p>
                    <p><strong>SKU:</strong> ${escapeHtml(productData.sku)}</p>
                    <p><strong>Giá:</strong> ${formatPrice(productData.basePrice)} VNĐ</p>
                    <p><strong>Trạng thái:</strong> ${productData.status === 'PUBLISHED' ? 'Xuất bản' : 'Nháp'}</p>
                    ${productData.description ? `<p><strong>Mô tả:</strong> ${escapeHtml(productData.description)}</p>` : ''}
                </div>
            `;

            if (productData.images.length > 0) {
                html += `
                    <div class="review-section">
                        <h4>Hình Ảnh (${productData.images.length})</h4>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            ${productData.images.map(img => `
                                <img src="${img.imageUrl}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 4px;" alt="Preview">
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            if (productData.variants.length > 0) {
                html += `
                    <div class="review-section">
                        <h4>Biến Thể (${productData.variants.length})</h4>
                        ${productData.variants.map(v => `
                            <p>${escapeHtml(v.name)}: ${escapeHtml(v.value)} - Giá: ${formatPrice(v.priceModifier)} VNĐ - Tồn kho: ${v.stockQuantity} - SKU: ${escapeHtml(v.sku)}</p>
                        `).join('')}
                    </div>
                `;
            }

            reviewContent.innerHTML = html;
        }

        function submitProduct() {
            collectStepData();

            if (!validateStep(1)) {
                return;
            }

            // Set status to PUBLISHED
            productData.status = 'PUBLISHED';
            
            // Submit form
            submitProductForm('PUBLISHED');
        }

        function formatPrice(price) {
            return new Intl.NumberFormat('vi-VN').format(price);
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
