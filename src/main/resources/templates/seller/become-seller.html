<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.parameterName}">
    <title>Trở thành Seller - E-commerce</title>
    
    <!-- CSS -->
    <link rel="stylesheet" th:href="@{/css/base.css}">
    <link rel="stylesheet" th:href="@{/css/layout.css}">
    <link rel="stylesheet" th:href="@{/css/components.css}">
    <link rel="stylesheet" th:href="@{/css/auth.css}">
    <link rel="stylesheet" th:href="@{/css/seller.css}">
</head>
<body>
    <!-- Header -->
    <th:block th:replace="~{fragments/header :: header-simple}"></th:block>
    
    <!-- Navigation -->
    <th:block th:replace="~{fragments/nav-seller :: nav-seller}"></th:block>
    
    <!-- Main Content -->
    <div class="main-content seller-content">
        <div class="container">
            <div class="form-container section">
                <h2>Trở thành Seller</h2>
                <!-- Flash Messages -->
                <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
                <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

                <!-- Status Display -->
                <div th:if="${request != null}">
                    <div th:if="${request.status == 'PENDING'}" class="alert alert-warning">
                        Yêu cầu của bạn đang chờ duyệt. Ngày gửi: <span th:text="${#temporals.format(request.createdAt, 'dd/MM/yyyy HH:mm')}"></span>
                    </div>
                    <div th:if="${request.status == 'APPROVED'}" class="alert alert-success">
                        Yêu cầu đã được duyệt! Bạn có thể quản lý shop ngay bây giờ.
                    </div>
                    <div th:if="${request.status == 'REJECTED'}" class="alert alert-danger">
                        Yêu cầu đã bị từ chối. Lý do: <span th:text="${request.rejectionReason}"></span>
                    </div>
                </div>

                <form id="sellerRequestForm" th:action="@{/seller/become-seller}" method="post" th:object="${sellerRequestRequest}" enctype="multipart/form-data">
                    <!-- CSRF Token -->
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                    <div class="form-group">
                        <label for="shopName">Tên Shop *</label>
                        <input type="text" id="shopName" th:field="*{shopName}" required>
                        <small>Tên shop phải có từ 3 đến 100 ký tự và không được trùng với shop khác</small>
                        <span th:if="${#fields.hasErrors('shopName')}" th:errors="*{shopName}" class="error-message"></span>
                    </div>

                    <div class="form-group">
                        <label for="shopDescription">Mô tả Shop</label>
                        <textarea id="shopDescription" th:field="*{shopDescription}"></textarea>
                        <small>Tối đa 2000 ký tự</small>
                        <span th:if="${#fields.hasErrors('shopDescription')}" th:errors="*{shopDescription}" class="error-message"></span>
                    </div>

                    <div class="form-group">
                        <label for="shopPhone">Số điện thoại Shop *</label>
                        <input type="tel" id="shopPhone" th:field="*{shopPhone}" required>
                        <span th:if="${#fields.hasErrors('shopPhone')}" th:errors="*{shopPhone}" class="error-message"></span>
                    </div>

                    <div class="form-group">
                        <label for="shopAddress">Địa chỉ Shop *</label>
                        <input type="text" id="shopAddress" th:field="*{shopAddress}" required>
                        <span th:if="${#fields.hasErrors('shopAddress')}" th:errors="*{shopAddress}" class="error-message"></span>
                    </div>

                    <div class="form-group">
                        <label for="logoFile">Logo Shop *</label>
                        <input type="file" id="logoFile" name="logoFile" accept="image/*" onchange="handleLogoPreview(event)">
                        <small>Chọn ảnh từ máy tính của bạn (JPG, PNG, GIF - tối đa 25MB)</small>
                        <div id="logoPreview" style="margin-top: 1rem; display: none;">
                            <img id="logoPreviewImg" src="" alt="Logo Preview" style="max-width: 200px; max-height: 200px; border-radius: 4px; object-fit: cover;">
                        </div>
                        <div th:if="${request != null && request.logoUrl != null}" style="margin-top: 0.5rem;">
                            <small>Logo hiện tại:</small>
                            <img th:src="${request.logoUrl}" alt="Current Logo" style="max-width: 150px; max-height: 150px; border-radius: 4px; object-fit: cover; display: block; margin-top: 0.5rem;">
                        </div>
                        <!-- Hidden input để lưu URL sau khi upload -->
                        <input type="hidden" id="logoUrl" name="logoUrl" th:value="${sellerRequestRequest?.logoUrl}">
                        <span th:if="${#fields.hasErrors('logoUrl')}" th:errors="*{logoUrl}" class="error-message"></span>
                    </div>

                    <div class="form-group">
                        <label for="coverImageFile">Ảnh Bìa Shop</label>
                        <input type="file" id="coverImageFile" name="coverImageFile" accept="image/*" onchange="handleCoverImagePreview(event)">
                        <small>Chọn ảnh từ máy tính của bạn (JPG, PNG, GIF - tối đa 25MB)</small>
                        <div id="coverImagePreview" style="margin-top: 1rem; display: none;">
                            <img id="coverImagePreviewImg" src="" alt="Cover Preview" style="max-width: 400px; max-height: 200px; border-radius: 4px; object-fit: cover;">
                        </div>
                        <div th:if="${request != null && request.coverImageUrl != null}" style="margin-top: 0.5rem;">
                            <small>Ảnh bìa hiện tại:</small>
                            <img th:src="${request.coverImageUrl}" alt="Current Cover" style="max-width: 400px; max-height: 200px; border-radius: 4px; object-fit: cover; display: block; margin-top: 0.5rem;">
                        </div>
                        <!-- Hidden input để lưu URL sau khi upload -->
                        <input type="hidden" id="coverImageUrl" name="coverImageUrl" th:value="${sellerRequestRequest?.coverImageUrl}">
                        <span th:if="${#fields.hasErrors('coverImageUrl')}" th:errors="*{coverImageUrl}" class="error-message"></span>
                    </div>

                    <div class="action-buttons">
                        <button type="submit" id="submitBtn" class="btn btn-primary">Gửi Yêu Cầu</button>
                        <a th:if="${request != null and request.status == 'PENDING'}" 
                           th:href="@{/seller/become-seller/update}" 
                           class="btn btn-secondary">Cập Nhật Request</a>
                        <form th:if="${request != null and request.status == 'PENDING'}" 
                              th:action="@{/seller/become-seller/cancel}" 
                              method="post" 
                              style="display: inline;">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <button type="submit" class="btn btn-danger" onclick="return confirm('Bạn có chắc muốn hủy yêu cầu?')">Hủy Request</button>
                        </form>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <th:block th:replace="~{fragments/footer :: footer}"></th:block>

    <!-- JavaScript -->
    <script th:src="@{/js/common.js}"></script>
    <script>

        // File upload helper (optional - can use separate upload endpoint)
        async function uploadFileAndSetUrl(fileInput, urlInputId, folder) {
            if (!fileInput.files || fileInput.files.length === 0) return;
            
            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('file', file);
            formData.append('folder', folder);
            
            try {
                // Get CSRF token
                const csrfToken = document.querySelector('meta[name="_csrf"]')?.content || 
                                 document.querySelector('input[name="_csrf"]')?.value;
                if (csrfToken) {
                    formData.append('_csrf', csrfToken);
                }
                
                const response = await fetch('/files/upload', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById(urlInputId).value = data.url;
                    alert('Upload thành công!');
                } else {
                    alert('Upload thất bại. Vui lòng thử lại.');
                }
            } catch (error) {
                alert('Lỗi khi upload file.');
            }
        }

        function displayRequestStatus(request) {
            const statusContainer = document.getElementById('statusContainer');
            let statusClass = '';
            let statusText = '';
            
            if (request.status === 'PENDING') {
                statusClass = 'status-pending';
                statusText = 'Đang chờ duyệt';
                document.getElementById('updateBtn').style.display = 'inline-block';
                document.getElementById('cancelBtn').style.display = 'inline-block';
                document.getElementById('submitBtn').style.display = 'none';
            } else if (request.status === 'APPROVED') {
                statusClass = 'status-approved';
                statusText = 'Đã được duyệt';
                disableForm();
            } else if (request.status === 'REJECTED') {
                statusClass = 'status-rejected';
                statusText = 'Đã bị từ chối';
                document.getElementById('updateBtn').style.display = 'inline-block';
                document.getElementById('submitBtn').style.display = 'none';
                
                if (request.rejectionReason) {
                    statusContainer.innerHTML += `
                        <div class="rejection-reason" style="margin-top: 1rem; padding: 1rem; background-color: #f8d7da; border-left: 4px solid #721c24; border-radius: 4px;">
                            <strong>Lý do từ chối:</strong>
                            <p>${request.rejectionReason}</p>
                        </div>
                    `;
                }
            }
            
            statusContainer.innerHTML = `
                <div class="status-badge ${statusClass}">${statusText}</div>
            ` + statusContainer.innerHTML;
        }

        function populateForm(request) {
            document.getElementById('shopName').value = request.shopName || '';
            document.getElementById('shopDescription').value = request.shopDescription || '';
            document.getElementById('shopPhone').value = request.shopPhone || '';
            document.getElementById('shopAddress').value = request.shopAddress || '';
            
            if (request.logoUrl) {
                const logoPreviewImg = document.getElementById('logoPreviewImg');
                const logoPreview = document.getElementById('logoPreview');
                if (logoPreviewImg && logoPreview) {
                    logoPreviewImg.src = request.logoUrl;
                    logoPreview.style.display = 'block';
                }
            }
            
            if (request.coverImageUrl) {
                const coverPreviewImg = document.getElementById('coverImagePreviewImg');
                const coverPreview = document.getElementById('coverImagePreview');
                if (coverPreviewImg && coverPreview) {
                    coverPreviewImg.src = request.coverImageUrl;
                    coverPreview.style.display = 'block';
                }
            }
        }

        function disableForm() {
            const form = document.getElementById('sellerRequestForm');
            const inputs = form.querySelectorAll('input, textarea, button');
            inputs.forEach(input => {
                input.disabled = true;
            });
        }

        function showStatus(status, message) {
            const statusContainer = document.getElementById('statusContainer');
            let statusClass = '';
            if (status === 'approved') statusClass = 'status-approved';
            else if (status === 'rejected') statusClass = 'status-rejected';
            else statusClass = 'status-pending';
            
            statusContainer.innerHTML = `
                <div class="status-badge ${statusClass}">${message}</div>
            `;
        }

        function handleLogoPreview(event) {
            const fileInput = event.target;
            const previewDiv = document.getElementById('logoPreview');
            const previewImg = document.getElementById('logoPreviewImg');
            const errorSpan = document.getElementById('logoFileError');

            // Check if elements exist
            if (!previewDiv || !previewImg) {
                console.error('Preview elements not found');
                return;
            }

            // Handle error span if it exists
            if (errorSpan) {
                errorSpan.classList.remove('show');
                errorSpan.textContent = '';
            }

            if (fileInput.files && fileInput.files[0]) {
                const file = fileInput.files[0];

                // Validate file size
                if (file.size > 25 * 1024 * 1024) {
                    if (errorSpan) {
                        errorSpan.textContent = 'Kích thước file không được vượt quá 25MB';
                        errorSpan.classList.add('show');
                    } else {
                        alert('Kích thước file không được vượt quá 25MB');
                    }
                    fileInput.value = '';
                    return;
                }

                // Validate file type
                if (!file.type.startsWith('image/')) {
                    if (errorSpan) {
                        errorSpan.textContent = 'Chỉ chấp nhận file ảnh';
                        errorSpan.classList.add('show');
                    } else {
                        alert('Chỉ chấp nhận file ảnh');
                    }
                    fileInput.value = '';
                    return;
                }

                // Show preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    previewDiv.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                previewDiv.style.display = 'none';
            }
        }

        function handleCoverImagePreview(event) {
            const fileInput = event.target;
            const previewDiv = document.getElementById('coverImagePreview');
            const previewImg = document.getElementById('coverImagePreviewImg');
            const errorSpan = document.getElementById('coverFileError');

            // Check if elements exist
            if (!previewDiv || !previewImg) {
                console.error('Preview elements not found');
                return;
            }

            // Handle error span if it exists
            if (errorSpan) {
                errorSpan.classList.remove('show');
                errorSpan.textContent = '';
            }

            if (fileInput.files && fileInput.files[0]) {
                const file = fileInput.files[0];

                // Validate file size
                if (file.size > 25 * 1024 * 1024) {
                    if (errorSpan) {
                        errorSpan.textContent = 'Kích thước file không được vượt quá 25MB';
                        errorSpan.classList.add('show');
                    } else {
                        alert('Kích thước file không được vượt quá 25MB');
                    }
                    fileInput.value = '';
                    return;
                }

                // Validate file type
                if (!file.type.startsWith('image/')) {
                    if (errorSpan) {
                        errorSpan.textContent = 'Chỉ chấp nhận file ảnh';
                        errorSpan.classList.add('show');
                    } else {
                        alert('Chỉ chấp nhận file ảnh');
                    }
                    fileInput.value = '';
                    return;
                }

                // Show preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    previewDiv.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                previewDiv.style.display = 'none';
            }
        }

        async function handleSubmitRequest() {
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Đang xử lý...';

            try {
                const shopName = document.getElementById('shopName').value.trim();
                const shopDescription = document.getElementById('shopDescription').value.trim();
                const shopPhone = document.getElementById('shopPhone').value.trim();
                const shopAddress = document.getElementById('shopAddress').value.trim();
                const logoFile = document.getElementById('logoFile').files[0];
                const coverFile = document.getElementById('coverFile').files[0];

                // Validate
                if (!logoFile) {
                    alert('Vui lòng chọn logo shop');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Gửi Yêu Cầu';
                    return;
                }

                let logoUrl = null;
                let coverImageUrl = null;

                // Upload logo
                if (logoFile) {
                    const formData = new FormData();
                    formData.append('file', logoFile);
                    formData.append('folder', 'shop-logos');

                    const uploadResponse = await AuthUtils.fetchWithAuth('/api/files/upload', {
                        method: 'POST',
                        body: formData
                    });

                    if (uploadResponse.ok) {
                        const uploadData = await uploadResponse.json();
                        logoUrl = uploadData.url;
                    } else {
                        const errorData = await uploadResponse.json().catch(() => ({}));
                        alert(errorData.message || 'Upload logo thất bại');
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Gửi Yêu Cầu';
                        return;
                    }
                }

                // Upload cover (optional)
                if (coverFile) {
                    const formData = new FormData();
                    formData.append('file', coverFile);
                    formData.append('folder', 'shop-covers');

                    const uploadResponse = await AuthUtils.fetchWithAuth('/api/files/upload', {
                        method: 'POST',
                        body: formData
                    });

                    if (uploadResponse.ok) {
                        const uploadData = await uploadResponse.json();
                        coverImageUrl = uploadData.url;
                    }
                }

                // Create request
                const response = await AuthUtils.fetchWithAuth('/api/seller/request', {
                    method: 'POST',
                    body: JSON.stringify({
                        shopName: shopName,
                        shopDescription: shopDescription,
                        shopPhone: shopPhone,
                        shopAddress: shopAddress,
                        logoUrl: logoUrl,
                        coverImageUrl: coverImageUrl
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    alert('Gửi yêu cầu thành công! Đang chờ admin duyệt.');
                    window.location.reload();
                } else {
                    alert(data.message || 'Gửi yêu cầu thất bại');
                }
            } catch (error) {
                alert('Đã xảy ra lỗi. Vui lòng thử lại sau.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Gửi Yêu Cầu';
            }
        }

        async function handleUpdateRequest() {
            if (!confirm('Bạn có chắc muốn cập nhật request này?')) {
                return;
            }

            const updateBtn = document.getElementById('updateBtn');
            updateBtn.disabled = true;
            updateBtn.textContent = 'Đang cập nhật...';

            try {
                const shopName = document.getElementById('shopName').value.trim();
                const shopDescription = document.getElementById('shopDescription').value.trim();
                const shopPhone = document.getElementById('shopPhone').value.trim();
                const shopAddress = document.getElementById('shopAddress').value.trim();
                const logoFile = document.getElementById('logoFile').files[0];
                const coverFile = document.getElementById('coverFile').files[0];

                let logoUrl = currentRequest?.logoUrl || null;
                let coverImageUrl = currentRequest?.coverImageUrl || null;

                // Upload new logo if provided
                if (logoFile) {
                    const formData = new FormData();
                    formData.append('file', logoFile);
                    formData.append('folder', 'shop-logos');

                    const uploadResponse = await AuthUtils.fetchWithAuth('/api/files/upload', {
                        method: 'POST',
                        body: formData
                    });

                    if (uploadResponse.ok) {
                        const uploadData = await uploadResponse.json();
                        logoUrl = uploadData.url;
                    }
                }

                // Upload new cover if provided
                if (coverFile) {
                    const formData = new FormData();
                    formData.append('file', coverFile);
                    formData.append('folder', 'shop-covers');

                    const uploadResponse = await AuthUtils.fetchWithAuth('/api/files/upload', {
                        method: 'POST',
                        body: formData
                    });

                    if (uploadResponse.ok) {
                        const uploadData = await uploadResponse.json();
                        coverImageUrl = uploadData.url;
                    }
                }

                const response = await AuthUtils.fetchWithAuth('/api/seller/request', {
                    method: 'PUT',
                    body: JSON.stringify({
                        shopName: shopName,
                        shopDescription: shopDescription,
                        shopPhone: shopPhone,
                        shopAddress: shopAddress,
                        logoUrl: logoUrl,
                        coverImageUrl: coverImageUrl
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    alert('Cập nhật request thành công!');
                    window.location.reload();
                } else {
                    alert(data.message || 'Cập nhật thất bại');
                }
            } catch (error) {
                alert('Đã xảy ra lỗi. Vui lòng thử lại sau.');
            } finally {
                updateBtn.disabled = false;
                updateBtn.textContent = 'Cập Nhật Request';
            }
        }

        async function handleCancelRequest() {
            if (!confirm('Bạn có chắc muốn hủy request này?')) {
                return;
            }

            try {
                const response = await AuthUtils.fetchWithAuth('/api/seller/request', {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (response.ok) {
                    alert('Đã hủy request thành công');
                    window.location.reload();
                } else {
                    alert(data.message || 'Hủy request thất bại');
                }
            } catch (error) {
                alert('Đã xảy ra lỗi. Vui lòng thử lại sau.');
            }
        }
    </script>
</body>
</html>
